name: test

on:
  workflow_dispatch:

  push:
    branches:
      - "containerized"

env:
  ARCH: arm64
  VARIANT: unstable
  RUNS_ON: ubuntu-24.04-arm
  ARTIFACTS_FOLDER: /tmp/artifacts

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:

  init-artifacts:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - id: init_artifacts
        run: |
          mkdir -p ${{ env.ARTIFACTS_FOLDER }}
          mkdir -p ${{ env.ARTIFACTS_FOLDER }}/metarepositories
      - id: prime_image
        run: |
          ./.ci/prime_image/prime_image.sh
      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: ${{ ARTIFACTS_FOLDER }}/
          overwrite: true

  generate-jobs:
    needs: init-artifacts
    runs-on: ubuntu-24.04-arm
    outputs:
      packages: ${{ steps.generate.outputs.packages }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: Checkout CI scripts
        uses: actions/checkout@v3
        with:
          repository: ctu-mrs/ci_scripts
          ref: master
          path: .ci_scripts
          token: ${{ secrets.PUSH_TOKEN }}
      - id: generate
        run: |
          JOB_STRATEGY_MATRIX=$(./.ci/get_build_matrix.sh mrs ${{ VARIANT }} ${{ ARCH }})
          cat /tmp/log.txt
          echo "packages=$JOB_STRATEGY_MATRIX" >> "$GITHUB_OUTPUT"

  build-job:
    needs: generate-jobs
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 360 # 6 hour timeout
    strategy:
      matrix:
        job: ${{ fromJson(needs.generate-jobs.outputs.packages) }}
      max-parallel: 1 # Run jobs serially
    steps:
      - name: Load artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts
          merge-multiple: true
          path: ${{ ARTIFACTS_FOLDER }}/
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: Checkout CI scripts
        uses: actions/checkout@v3
        with:
          repository: ctu-mrs/ci_scripts
          ref: master
          path: .ci_scripts
          token: ${{ secrets.PUSH_TOKEN }}
      - id: build
        run: |
          .ci/build.sh mrs ${{ VARIANT }} "${{ matrix.job }}"
          ls ${{ ARTIFACTS_FOLDER }}
      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: ${{ ARTIFACTS_FOLDER }}/
          overwrite: true

  collect-artifacts:
    runs-on: ubuntu-24.04-arm
    needs: build-job
    env:
      PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
    steps:
      - name: Load artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts
          merge-multiple: true
          path: ${{ ARTIFACTS_FOLDER }}/
      - id: execute
        run: |
          rm ${{ ARTIFACTS_FOLDER }}/builder.tar 2> /dev/null || true
          rm ${{ ARTIFACTS_FOLDER }}/compiled.txt 2> /dev/null || true
          rm ${{ ARTIFACTS_FOLDER }}/compile_further.txt 2> /dev/null || true
          rm ${{ ARTIFACTS_FOLDER }}/base_sha.txt 2> /dev/null || true
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: Checkout CI scripts
        uses: actions/checkout@v3
        with:
          repository: ctu-mrs/ci_scripts
          ref: master
          path: .ci_scripts
          token: ${{ secrets.PUSH_TOKEN }}
      - name: Deploy
        run: .ci_scripts/package_build/push_to_ppa.sh ${{ VARIANT }} ${{ ARTIFACTS_FOLDER }}
